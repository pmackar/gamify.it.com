generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// UNIFIED CORE TABLES (existing)
// ============================================

/// Global user profile - shared across all apps
model profiles {
  id                 String              @id @db.Uuid
  email              String              @unique
  username           String?             @unique
  display_name       String?
  avatar_url         String?
  bio                String?
  total_xp           Int?                @default(0)
  main_level         Int?                @default(1)
  current_streak     Int?                @default(0)
  longest_streak     Int?                @default(0)
  last_activity_date DateTime?           @db.Date
  legacy_prisma_id   String?
  legacy_clerk_id    String?
  created_at         DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?           @default(now()) @db.Timestamptz(6)

  // Relations
  app_profiles       app_profiles[]
  user_achievements  user_achievements[]

  // Travel relations
  travel_cities        travel_cities[]
  travel_neighborhoods travel_neighborhoods[]
  travel_locations     travel_locations[]
  travel_visits        travel_visits[]
  travel_photos        travel_photos[]
  travel_reviews       travel_reviews[]
  travel_quests        travel_quests[]
  travel_user_location_data travel_user_location_data[]

  // Quest item attribution
  quest_items_added     travel_quest_items[] @relation("QuestItemAddedBy")
  quest_items_completed travel_quest_items[] @relation("QuestItemCompletedBy")

  // Social relations
  friendships_sent     friendships[] @relation("FriendshipRequester")
  friendships_received friendships[] @relation("FriendshipAddressee")
  party_memberships    quest_party_members[]
  activity_feed_owned  activity_feed[] @relation("ActivityFeedOwner")
  activity_feed_actor  activity_feed[] @relation("ActivityFeedActor")

  @@index([email], map: "idx_profiles_email")
  @@index([username], map: "idx_profiles_username")
}

/// Per-app XP and level tracking
model app_profiles {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  app_id     String    // 'travel', 'fitness', 'today'
  xp         Int?      @default(0)
  level      Int?      @default(1)
  xp_to_next Int?      @default(100)
  stats      Json?     @default("{}")
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  profiles   profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, app_id])
  @@index([app_id], map: "idx_app_profiles_app_id")
  @@index([user_id], map: "idx_app_profiles_user_id")
}

/// Unified achievements across all apps
model achievements {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code              String              @unique
  app_id            String              // 'travel', 'fitness', 'today', 'global'
  name              String
  description       String
  icon              String?
  xp_reward         Int?                @default(0)
  category          String
  tier              Int?                @default(1)
  criteria          Json                @default("{}")
  created_at        DateTime?           @default(now()) @db.Timestamptz(6)

  user_achievements user_achievements[]

  @@index([app_id], map: "idx_achievements_app_id")
}

/// User achievement progress and completion
model user_achievements {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String       @db.Uuid
  achievement_id String       @db.Uuid
  progress       Int?         @default(0)
  is_completed   Boolean?     @default(false)
  completed_at   DateTime?    @db.Timestamptz(6)
  created_at     DateTime?    @default(now()) @db.Timestamptz(6)

  achievements   achievements @relation(fields: [achievement_id], references: [id], onDelete: Cascade)
  profiles       profiles     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, achievement_id])
  @@index([user_id], map: "idx_user_achievements_user_id")
}

/// Generic user data storage (for today app)
model user_data {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?   @unique @db.Uuid
  data       Json
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// Today app specific data
model gamify_today_data {
  user_id    String    @id @db.Uuid
  data       Json      @default("{}")
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// Fitness app specific data
model gamify_fitness_data {
  user_id    String    @id @db.Uuid
  data       Json      @default("{}")
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

// ============================================
// TRAVEL APP TABLES
// ============================================

model travel_cities {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  country       String
  region        String?
  country_code  String?
  latitude      Float?
  longitude     Float?
  first_visited DateTime? @db.Timestamptz(6)
  last_visited  DateTime? @db.Timestamptz(6)
  visit_count   Int       @default(1)
  notes         String?
  location_count Int      @default(0)

  user_id       String    @db.Uuid
  user          profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  neighborhoods travel_neighborhoods[]
  locations     travel_locations[]
  quests        travel_quests[]

  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @default(now()) @db.Timestamptz(6)

  @@unique([user_id, name, country])
  @@index([user_id])
  @@index([country])
}

model travel_neighborhoods {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  latitude    Float?
  longitude   Float?

  user_id     String     @db.Uuid
  user        profiles   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  city_id     String     @db.Uuid
  city        travel_cities @relation(fields: [city_id], references: [id], onDelete: Cascade)

  locations   travel_locations[]
  quests      travel_quests[]

  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  updated_at  DateTime   @default(now()) @db.Timestamptz(6)

  @@unique([user_id, city_id, name])
  @@index([user_id])
  @@index([city_id])
}

enum travel_location_type {
  RESTAURANT
  BAR
  CAFE
  ATTRACTION
  HOTEL
  SHOP
  NATURE
  TRANSPORT
  MUSEUM
  BEACH
  NIGHTLIFE
  OTHER
}

model travel_locations {
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  type           travel_location_type
  cuisine        String?
  address        String?
  latitude       Float
  longitude      Float
  blurb          String?
  description    String?
  website        String?
  phone          String?
  hours          String?
  price_level    Int?
  other_info     String?
  visited        Boolean             @default(false)
  hotlist        Boolean             @default(false)
  tags           String[]

  // Aggregate stats
  avg_rating     Float?
  rating_count   Int                 @default(0)
  review_count   Int                 @default(0)
  total_visits   Int                 @default(0)

  // Owner/creator
  user_id        String?             @db.Uuid
  user           profiles?           @relation(fields: [user_id], references: [id], onDelete: SetNull)

  city_id        String              @db.Uuid
  city           travel_cities       @relation(fields: [city_id], references: [id], onDelete: Cascade)
  neighborhood_id String?            @db.Uuid
  neighborhood   travel_neighborhoods? @relation(fields: [neighborhood_id], references: [id], onDelete: SetNull)

  visits         travel_visits[]
  photos         travel_photos[]
  user_data      travel_user_location_data[]
  reviews        travel_reviews[]
  quest_items    travel_quest_items[]

  created_at     DateTime            @default(now()) @db.Timestamptz(6)
  updated_at     DateTime            @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([city_id])
  @@index([neighborhood_id])
  @@index([type])
  @@index([latitude, longitude])
  // Compound indexes for common query patterns
  @@index([user_id, city_id])
  @@index([user_id, type])
  @@index([user_id, visited])
  @@index([user_id, hotlist])
}

model travel_visits {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date            DateTime         @db.Timestamptz(6)
  overall_rating  Float?
  food_quality    Int?
  service_rating  Int?
  ambiance_rating Int?
  value_rating    Int?
  notes           String?
  highlights      String[]
  xp_earned       Int              @default(0)

  user_id         String           @db.Uuid
  user            profiles         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location_id     String           @db.Uuid
  location        travel_locations @relation(fields: [location_id], references: [id], onDelete: Cascade)

  photos          travel_photos[]

  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([location_id])
  @@index([date])
}

model travel_photos {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  url         String
  caption     String?

  user_id     String            @db.Uuid
  user        profiles          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location_id String?           @db.Uuid
  location    travel_locations? @relation(fields: [location_id], references: [id], onDelete: Cascade)
  visit_id    String?           @db.Uuid
  visit       travel_visits?    @relation(fields: [visit_id], references: [id], onDelete: Cascade)

  created_at  DateTime          @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([location_id])
  @@index([visit_id])
}

/// Per-user data for each location (hotlist, personal notes, etc.)
model travel_user_location_data {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hotlist         Boolean          @default(false)
  visited         Boolean          @default(false)
  personal_rating Float?
  notes           String?
  visit_count     Int              @default(0)
  first_visited_at DateTime?       @db.Timestamptz(6)
  last_visited_at  DateTime?       @db.Timestamptz(6)

  user_id         String           @db.Uuid
  user            profiles         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location_id     String           @db.Uuid
  location        travel_locations @relation(fields: [location_id], references: [id], onDelete: Cascade)

  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @default(now()) @db.Timestamptz(6)

  @@unique([user_id, location_id])
  @@index([user_id])
  @@index([location_id])
  // Compound indexes for filtering user's locations
  @@index([user_id, visited])
  @@index([user_id, hotlist])
}

enum travel_review_status {
  PENDING
  APPROVED
  REJECTED
}

model travel_reviews {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title           String?
  content         String
  rating          Float
  status          travel_review_status @default(PENDING)
  moderated_at    DateTime?           @db.Timestamptz(6)
  moderated_by    String?
  food_quality    Int?
  service_rating  Int?
  ambiance_rating Int?
  value_rating    Int?

  author_id       String              @db.Uuid
  author          profiles            @relation(fields: [author_id], references: [id], onDelete: Cascade)
  location_id     String              @db.Uuid
  location        travel_locations    @relation(fields: [location_id], references: [id], onDelete: Cascade)

  created_at      DateTime            @default(now()) @db.Timestamptz(6)
  updated_at      DateTime            @default(now()) @db.Timestamptz(6)

  @@index([author_id])
  @@index([location_id])
  @@index([status])
}

enum travel_quest_status {
  PLANNING
  ACTIVE
  COMPLETED
  ARCHIVED
}

model travel_quests {
  id                     String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String
  description            String?
  target_city_id         String?               @db.Uuid
  target_city            travel_cities?        @relation(fields: [target_city_id], references: [id], onDelete: SetNull)
  target_neighborhood_id String?               @db.Uuid
  target_neighborhood    travel_neighborhoods? @relation(fields: [target_neighborhood_id], references: [id], onDelete: SetNull)
  start_date             DateTime?             @db.Timestamptz(6)
  end_date               DateTime?             @db.Timestamptz(6)
  status                 travel_quest_status   @default(PLANNING)

  user_id                String                @db.Uuid
  user                   profiles              @relation(fields: [user_id], references: [id], onDelete: Cascade)

  items                  travel_quest_items[]
  party                  quest_parties?

  created_at             DateTime              @default(now()) @db.Timestamptz(6)
  updated_at             DateTime              @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([status])
  @@index([target_city_id])
  @@index([target_neighborhood_id])
}

model travel_quest_items {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  completed    Boolean          @default(false)
  completed_at DateTime?        @db.Timestamptz(6)
  sort_order   Int              @default(0)
  priority     Int              @default(0)
  notes        String?

  quest_id     String           @db.Uuid
  quest        travel_quests    @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  location_id  String           @db.Uuid
  location     travel_locations @relation(fields: [location_id], references: [id], onDelete: Cascade)

  // Party attribution
  added_by_id     String?       @db.Uuid
  added_by        profiles?     @relation("QuestItemAddedBy", fields: [added_by_id], references: [id], onDelete: SetNull)
  completed_by_id String?       @db.Uuid
  completed_by    profiles?     @relation("QuestItemCompletedBy", fields: [completed_by_id], references: [id], onDelete: SetNull)

  @@unique([quest_id, location_id])
  @@index([quest_id])
  @@index([location_id])
}

// ============================================
// SOCIAL SYSTEM TABLES (Platform-wide)
// ============================================

enum friendship_status {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

/// Platform-wide friendship relationships (bidirectional)
model friendships {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requester_id String            @db.Uuid
  requester    profiles          @relation("FriendshipRequester", fields: [requester_id], references: [id], onDelete: Cascade)
  addressee_id String            @db.Uuid
  addressee    profiles          @relation("FriendshipAddressee", fields: [addressee_id], references: [id], onDelete: Cascade)
  status       friendship_status @default(PENDING)
  created_at   DateTime          @default(now()) @db.Timestamptz(6)
  accepted_at  DateTime?         @db.Timestamptz(6)

  @@unique([requester_id, addressee_id])
  @@index([requester_id])
  @@index([addressee_id])
  @@index([status])
}

enum party_member_role {
  OWNER
  MEMBER
}

enum party_invite_status {
  PENDING
  ACCEPTED
  DECLINED
}

/// Party for collaborative quest editing (1:1 with quest)
model quest_parties {
  id         String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id   String                @unique @db.Uuid
  quest      travel_quests         @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  created_at DateTime              @default(now()) @db.Timestamptz(6)

  members    quest_party_members[]

  @@index([quest_id])
}

/// Party membership associations
model quest_party_members {
  id         String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  party_id   String              @db.Uuid
  party      quest_parties       @relation(fields: [party_id], references: [id], onDelete: Cascade)
  user_id    String              @db.Uuid
  user       profiles            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role       party_member_role   @default(MEMBER)
  status     party_invite_status @default(PENDING)
  invited_at DateTime            @default(now()) @db.Timestamptz(6)
  joined_at  DateTime?           @db.Timestamptz(6)

  @@unique([party_id, user_id])
  @@index([party_id])
  @@index([user_id])
  @@index([status])
}

enum activity_type {
  FRIEND_REQUEST_RECEIVED
  FRIEND_REQUEST_ACCEPTED
  PARTY_INVITE_RECEIVED
  PARTY_MEMBER_JOINED
  QUEST_ITEM_ADDED
  QUEST_ITEM_COMPLETED
  QUEST_COMPLETED
}

/// Activity feed for social notifications
model activity_feed {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String        @db.Uuid  // Target user (who should see this)
  user        profiles      @relation("ActivityFeedOwner", fields: [user_id], references: [id], onDelete: Cascade)
  actor_id    String        @db.Uuid  // Who performed the action
  actor       profiles      @relation("ActivityFeedActor", fields: [actor_id], references: [id], onDelete: Cascade)
  type        activity_type
  entity_type String?                 // 'quest', 'location', 'friendship'
  entity_id   String?       @db.Uuid  // ID of the related entity
  metadata    Json          @default("{}")
  read        Boolean       @default(false)
  created_at  DateTime      @default(now()) @db.Timestamptz(6)

  @@index([user_id, read])
  @@index([user_id, created_at])
  @@index([actor_id])
}
