generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// PERMISSIONS & SUBSCRIPTIONS
// ============================================

enum user_role {
  USER
  ADMIN
}

enum subscription_tier {
  FREE
  PREMIUM
  COACH
  PRO
}

enum subscription_status {
  ACTIVE
  TRIAL
  CANCELLED
  EXPIRED
  PAUSED
}

/// Global user roles (admin, user)
model user_roles {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @unique @db.Uuid
  user       profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role       user_role @default(USER)
  granted_at DateTime  @default(now()) @db.Timestamptz(6)
  granted_by String?   @db.Uuid

  @@index([user_id])
  @@index([role])
}

/// Per-app subscriptions/tiers
model user_subscriptions {
  id                     String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                String              @db.Uuid
  user                   profiles            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  app_id                 String              // 'fitness', 'today', 'travel', 'global'
  tier                   subscription_tier   @default(FREE)
  status                 subscription_status @default(ACTIVE)
  features               String[]            @default([]) // Additional feature flags
  started_at             DateTime            @default(now()) @db.Timestamptz(6)
  expires_at             DateTime?           @db.Timestamptz(6)
  trial_ends_at          DateTime?           @db.Timestamptz(6)
  stripe_subscription_id String?
  stripe_customer_id     String?
  cancelled_at           DateTime?           @db.Timestamptz(6)
  created_at             DateTime            @default(now()) @db.Timestamptz(6)
  updated_at             DateTime            @default(now()) @db.Timestamptz(6)

  @@unique([user_id, app_id])
  @@index([user_id])
  @@index([app_id])
  @@index([tier])
  @@index([status])
}

/// Feature definitions per app (for documentation and admin)
model app_features {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  app_id      String            // 'fitness', 'today', 'travel', 'global'
  feature_key String            // 'unlimited_templates', 'client_management'
  name        String
  description String?
  min_tier    subscription_tier @default(FREE)
  created_at  DateTime          @default(now()) @db.Timestamptz(6)

  @@unique([app_id, feature_key])
  @@index([app_id])
  @@index([min_tier])
}

// ============================================
// UNIFIED CORE TABLES (existing)
// ============================================

/// Global user profile - shared across all apps
model profiles {
  id                 String              @id @db.Uuid
  email              String              @unique
  username           String?             @unique
  display_name       String?
  avatar_url         String?
  bio                String?
  total_xp           Int?                @default(0)
  main_level         Int?                @default(1)
  current_streak     Int?                @default(0)
  longest_streak     Int?                @default(0)
  last_activity_date DateTime?           @db.Date

  // Gamification: Streak Protection & Daily Rewards
  streak_shields     Int?                @default(0)  // Number of streak shields available
  login_streak       Int?                @default(0)  // Consecutive days claiming login reward
  last_login_claim   DateTime?           @db.Date     // Last date login reward was claimed

  legacy_prisma_id   String?
  legacy_clerk_id    String?
  created_at         DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?           @default(now()) @db.Timestamptz(6)

  // Relations
  app_profiles       app_profiles[]
  user_achievements  user_achievements[]
  daily_login_claims daily_login_claims[]
  user_inventory     user_inventory[]

  // Travel relations
  travel_cities        travel_cities[]
  travel_neighborhoods travel_neighborhoods[]
  travel_locations     travel_locations[]
  travel_visits        travel_visits[]
  travel_photos        travel_photos[]
  travel_reviews       travel_reviews[]
  travel_quests        travel_quests[]
  travel_user_location_data travel_user_location_data[]

  // Quest item attribution
  quest_items_added     travel_quest_items[] @relation("QuestItemAddedBy")
  quest_items_completed travel_quest_items[] @relation("QuestItemCompletedBy")

  // Social relations
  friendships_sent     friendships[] @relation("FriendshipRequester")
  friendships_received friendships[] @relation("FriendshipAddressee")
  party_memberships    quest_party_members[]
  activity_feed_owned  activity_feed[] @relation("ActivityFeedOwner")
  activity_feed_actor  activity_feed[] @relation("ActivityFeedActor")
  activity_kudos_given activity_kudos[] @relation("ActivityKudosGiver")
  activity_comments    activity_comments[] @relation("ActivityCommentAuthor")

  // Coaching relations
  coach_profile        coach_profiles?
  coached_by           coaching_relationships[] @relation("AthleteCoaching")

  // Permission relations
  user_role            user_roles?
  subscriptions        user_subscriptions[]

  @@index([email], map: "idx_profiles_email")
  @@index([username], map: "idx_profiles_username")
}

/// Per-app XP and level tracking
model app_profiles {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  app_id     String    // 'travel', 'fitness', 'today'
  xp         Int?      @default(0)
  level      Int?      @default(1)
  xp_to_next Int?      @default(100)
  stats      Json?     @default("{}")
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  profiles   profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, app_id])
  @@index([app_id], map: "idx_app_profiles_app_id")
  @@index([user_id], map: "idx_app_profiles_user_id")
}

/// Unified achievements across all apps
model achievements {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code              String              @unique
  app_id            String              // 'travel', 'fitness', 'today', 'global'
  name              String
  description       String
  icon              String?
  xp_reward         Int?                @default(0)
  category          String
  tier              Int?                @default(1)
  criteria          Json                @default("{}")
  created_at        DateTime?           @default(now()) @db.Timestamptz(6)

  user_achievements user_achievements[]

  @@index([app_id], map: "idx_achievements_app_id")
}

/// User achievement progress and completion
model user_achievements {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String       @db.Uuid
  achievement_id String       @db.Uuid
  progress       Int?         @default(0)
  is_completed   Boolean?     @default(false)
  completed_at   DateTime?    @db.Timestamptz(6)
  created_at     DateTime?    @default(now()) @db.Timestamptz(6)

  achievements   achievements @relation(fields: [achievement_id], references: [id], onDelete: Cascade)
  profiles       profiles     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, achievement_id])
  @@index([user_id], map: "idx_user_achievements_user_id")
}

/// Generic user data storage (for today app)
model user_data {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?   @unique @db.Uuid
  data       Json
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// Today app specific data
model gamify_today_data {
  user_id    String    @id @db.Uuid
  data       Json      @default("{}")
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// Fitness app specific data
model gamify_fitness_data {
  user_id    String    @id @db.Uuid
  data       Json      @default("{}")
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

// ============================================
// TRAVEL APP TABLES
// ============================================

model travel_cities {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  country       String
  region        String?
  country_code  String?
  latitude      Float?
  longitude     Float?
  first_visited DateTime? @db.Timestamptz(6)
  last_visited  DateTime? @db.Timestamptz(6)
  visit_count   Int       @default(1)
  notes         String?
  location_count Int      @default(0)

  user_id       String    @db.Uuid
  user          profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  neighborhoods travel_neighborhoods[]
  locations     travel_locations[]
  quests        travel_quests[]
  quest_cities  travel_quest_cities[]

  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @default(now()) @db.Timestamptz(6)

  @@unique([user_id, name, country])
  @@index([user_id])
  @@index([country])
}

model travel_neighborhoods {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  latitude    Float?
  longitude   Float?

  user_id     String     @db.Uuid
  user        profiles   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  city_id     String     @db.Uuid
  city        travel_cities @relation(fields: [city_id], references: [id], onDelete: Cascade)

  locations           travel_locations[]
  quests              travel_quests[]
  quest_neighborhoods travel_quest_neighborhoods[]

  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  updated_at  DateTime   @default(now()) @db.Timestamptz(6)

  @@unique([user_id, city_id, name])
  @@index([user_id])
  @@index([city_id])
}

enum travel_location_type {
  RESTAURANT
  BAR
  CAFE
  ATTRACTION
  HOTEL
  SHOP
  NATURE
  TRANSPORT
  MUSEUM
  BEACH
  NIGHTLIFE
  OTHER
}

model travel_locations {
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  type           travel_location_type
  cuisine        String?
  address        String?
  latitude       Float
  longitude      Float
  blurb          String?
  description    String?
  website        String?
  phone          String?
  hours          String?
  price_level    Int?
  other_info     String?
  visited        Boolean             @default(false)
  hotlist        Boolean             @default(false)
  tags           String[]

  // Aggregate stats
  avg_rating     Float?
  rating_count   Int                 @default(0)
  review_count   Int                 @default(0)
  total_visits   Int                 @default(0)

  // Owner/creator
  user_id        String?             @db.Uuid
  user           profiles?           @relation(fields: [user_id], references: [id], onDelete: SetNull)

  city_id        String              @db.Uuid
  city           travel_cities       @relation(fields: [city_id], references: [id], onDelete: Cascade)
  neighborhood_id String?            @db.Uuid
  neighborhood   travel_neighborhoods? @relation(fields: [neighborhood_id], references: [id], onDelete: SetNull)

  visits         travel_visits[]
  photos         travel_photos[]
  user_data      travel_user_location_data[]
  reviews        travel_reviews[]
  quest_items    travel_quest_items[]

  created_at     DateTime            @default(now()) @db.Timestamptz(6)
  updated_at     DateTime            @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([city_id])
  @@index([neighborhood_id])
  @@index([type])
  @@index([latitude, longitude])
  // Compound indexes for common query patterns
  @@index([user_id, city_id])
  @@index([user_id, type])
  @@index([user_id, visited])
  @@index([user_id, hotlist])
}

model travel_visits {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date            DateTime         @db.Timestamptz(6)
  overall_rating  Float?
  food_quality    Int?
  service_rating  Int?
  ambiance_rating Int?
  value_rating    Int?
  notes           String?
  highlights      String[]
  xp_earned       Int              @default(0)

  user_id         String           @db.Uuid
  user            profiles         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location_id     String           @db.Uuid
  location        travel_locations @relation(fields: [location_id], references: [id], onDelete: Cascade)

  photos          travel_photos[]

  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([location_id])
  @@index([date])
}

model travel_photos {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  url         String
  caption     String?

  user_id     String            @db.Uuid
  user        profiles          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location_id String?           @db.Uuid
  location    travel_locations? @relation(fields: [location_id], references: [id], onDelete: Cascade)
  visit_id    String?           @db.Uuid
  visit       travel_visits?    @relation(fields: [visit_id], references: [id], onDelete: Cascade)

  created_at  DateTime          @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([location_id])
  @@index([visit_id])
}

/// Per-user data for each location (hotlist, personal notes, etc.)
model travel_user_location_data {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hotlist         Boolean          @default(false)
  visited         Boolean          @default(false)
  personal_rating Float?
  notes           String?
  visit_count     Int              @default(0)
  first_visited_at DateTime?       @db.Timestamptz(6)
  last_visited_at  DateTime?       @db.Timestamptz(6)

  user_id         String           @db.Uuid
  user            profiles         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location_id     String           @db.Uuid
  location        travel_locations @relation(fields: [location_id], references: [id], onDelete: Cascade)

  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @default(now()) @db.Timestamptz(6)

  @@unique([user_id, location_id])
  @@index([user_id])
  @@index([location_id])
  // Compound indexes for filtering user's locations
  @@index([user_id, visited])
  @@index([user_id, hotlist])
}

enum travel_review_status {
  PENDING
  APPROVED
  REJECTED
}

model travel_reviews {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title           String?
  content         String
  rating          Float
  status          travel_review_status @default(PENDING)
  moderated_at    DateTime?           @db.Timestamptz(6)
  moderated_by    String?
  food_quality    Int?
  service_rating  Int?
  ambiance_rating Int?
  value_rating    Int?

  author_id       String              @db.Uuid
  author          profiles            @relation(fields: [author_id], references: [id], onDelete: Cascade)
  location_id     String              @db.Uuid
  location        travel_locations    @relation(fields: [location_id], references: [id], onDelete: Cascade)

  created_at      DateTime            @default(now()) @db.Timestamptz(6)
  updated_at      DateTime            @default(now()) @db.Timestamptz(6)

  @@index([author_id])
  @@index([location_id])
  @@index([status])
}

enum travel_quest_status {
  PLANNING
  ACTIVE
  COMPLETED
  ARCHIVED
}

model travel_quests {
  id                     String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String
  description            String?
  target_city_id         String?               @db.Uuid
  target_city            travel_cities?        @relation(fields: [target_city_id], references: [id], onDelete: SetNull)
  target_neighborhood_id String?               @db.Uuid
  target_neighborhood    travel_neighborhoods? @relation(fields: [target_neighborhood_id], references: [id], onDelete: SetNull)
  start_date             DateTime?             @db.Timestamptz(6)
  end_date               DateTime?             @db.Timestamptz(6)
  status                 travel_quest_status   @default(PLANNING)

  user_id                String                @db.Uuid
  user                   profiles              @relation(fields: [user_id], references: [id], onDelete: Cascade)

  items                  travel_quest_items[]
  party                  quest_parties?

  // Multi-city/neighborhood support
  cities                 travel_quest_cities[]
  neighborhoods          travel_quest_neighborhoods[]

  created_at             DateTime              @default(now()) @db.Timestamptz(6)
  updated_at             DateTime              @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([status])
  @@index([target_city_id])
  @@index([target_neighborhood_id])
}

model travel_quest_items {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  completed    Boolean          @default(false)
  completed_at DateTime?        @db.Timestamptz(6)
  sort_order   Int              @default(0)
  priority     Int              @default(0)
  notes        String?

  quest_id     String           @db.Uuid
  quest        travel_quests    @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  location_id  String           @db.Uuid
  location     travel_locations @relation(fields: [location_id], references: [id], onDelete: Cascade)

  // Party attribution
  added_by_id     String?       @db.Uuid
  added_by        profiles?     @relation("QuestItemAddedBy", fields: [added_by_id], references: [id], onDelete: SetNull)
  completed_by_id String?       @db.Uuid
  completed_by    profiles?     @relation("QuestItemCompletedBy", fields: [completed_by_id], references: [id], onDelete: SetNull)

  @@unique([quest_id, location_id])
  @@index([quest_id])
  @@index([location_id])
}

/// Multi-city support for quests (junction table)
model travel_quest_cities {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id   String        @db.Uuid
  quest      travel_quests @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  city_id    String        @db.Uuid
  city       travel_cities @relation(fields: [city_id], references: [id], onDelete: Cascade)
  sort_order Int           @default(0)

  @@unique([quest_id, city_id])
  @@index([quest_id])
  @@index([city_id])
}

/// Multi-neighborhood support for quests (junction table)
model travel_quest_neighborhoods {
  id              String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id        String               @db.Uuid
  quest           travel_quests        @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  neighborhood_id String               @db.Uuid
  neighborhood    travel_neighborhoods @relation(fields: [neighborhood_id], references: [id], onDelete: Cascade)

  @@unique([quest_id, neighborhood_id])
  @@index([quest_id])
  @@index([neighborhood_id])
}

// ============================================
// SOCIAL SYSTEM TABLES (Platform-wide)
// ============================================

enum friendship_status {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

/// Platform-wide friendship relationships (bidirectional)
model friendships {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requester_id String            @db.Uuid
  requester    profiles          @relation("FriendshipRequester", fields: [requester_id], references: [id], onDelete: Cascade)
  addressee_id String            @db.Uuid
  addressee    profiles          @relation("FriendshipAddressee", fields: [addressee_id], references: [id], onDelete: Cascade)
  status       friendship_status @default(PENDING)
  created_at   DateTime          @default(now()) @db.Timestamptz(6)
  accepted_at  DateTime?         @db.Timestamptz(6)

  @@unique([requester_id, addressee_id])
  @@index([requester_id])
  @@index([addressee_id])
  @@index([status])
}

enum party_member_role {
  OWNER
  MEMBER
}

enum party_invite_status {
  PENDING
  ACCEPTED
  DECLINED
}

/// Party for collaborative quest editing (1:1 with quest)
model quest_parties {
  id         String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id   String                @unique @db.Uuid
  quest      travel_quests         @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  created_at DateTime              @default(now()) @db.Timestamptz(6)

  members    quest_party_members[]

  @@index([quest_id])
}

/// Party membership associations
model quest_party_members {
  id         String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  party_id   String              @db.Uuid
  party      quest_parties       @relation(fields: [party_id], references: [id], onDelete: Cascade)
  user_id    String              @db.Uuid
  user       profiles            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role       party_member_role   @default(MEMBER)
  status     party_invite_status @default(PENDING)
  invited_at DateTime            @default(now()) @db.Timestamptz(6)
  joined_at  DateTime?           @db.Timestamptz(6)

  @@unique([party_id, user_id])
  @@index([party_id])
  @@index([user_id])
  @@index([status])
}

enum activity_type {
  FRIEND_REQUEST_RECEIVED
  FRIEND_REQUEST_ACCEPTED
  PARTY_INVITE_RECEIVED
  PARTY_MEMBER_JOINED
  QUEST_ITEM_ADDED
  QUEST_ITEM_COMPLETED
  QUEST_COMPLETED
  COMMENT
  KUDOS
}

/// Activity feed for social notifications
model activity_feed {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String        @db.Uuid  // Target user (who should see this)
  user        profiles      @relation("ActivityFeedOwner", fields: [user_id], references: [id], onDelete: Cascade)
  actor_id    String        @db.Uuid  // Who performed the action
  actor       profiles      @relation("ActivityFeedActor", fields: [actor_id], references: [id], onDelete: Cascade)
  type        activity_type
  entity_type String?                 // 'quest', 'location', 'friendship'
  entity_id   String?       @db.Uuid  // ID of the related entity
  metadata    Json          @default("{}")
  read        Boolean       @default(false)
  created_at  DateTime      @default(now()) @db.Timestamptz(6)
  kudos       activity_kudos[]
  comments    activity_comments[]

  @@index([user_id, read])
  @@index([user_id, created_at])
  @@index([actor_id])
}

/// Kudos/reactions on activity feed items
model activity_kudos {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  activity_id String       @db.Uuid
  activity    activity_feed @relation(fields: [activity_id], references: [id], onDelete: Cascade)
  user_id     String       @db.Uuid
  user        profiles     @relation("ActivityKudosGiver", fields: [user_id], references: [id], onDelete: Cascade)
  emoji       String       @default("ðŸ”¥")  // Fire, thumbs up, etc.
  created_at  DateTime     @default(now()) @db.Timestamptz(6)

  @@unique([activity_id, user_id])
  @@index([activity_id])
  @@index([user_id])
}

/// Comments on activity feed items
model activity_comments {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  activity_id String        @db.Uuid
  activity    activity_feed @relation(fields: [activity_id], references: [id], onDelete: Cascade)
  user_id     String        @db.Uuid
  user        profiles      @relation("ActivityCommentAuthor", fields: [user_id], references: [id], onDelete: Cascade)
  content     String        @db.VarChar(500)
  created_at  DateTime      @default(now()) @db.Timestamptz(6)
  updated_at  DateTime      @default(now()) @db.Timestamptz(6)

  @@index([activity_id])
  @@index([user_id])
  @@index([created_at])
}

// ============================================
// FITNESS COACHING SYSTEM TABLES
// ============================================

enum coaching_relationship_status {
  PENDING
  ACTIVE
  PAUSED
  ENDED
}

/// Coach profile - extends user profile with coaching capabilities
model coach_profiles {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String    @unique @db.Uuid
  user            profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  business_name   String?
  specializations String[]  // ["powerlifting", "bodybuilding", "general fitness"]
  bio             String?
  is_verified     Boolean   @default(false)
  max_athletes    Int       @default(10)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @default(now()) @db.Timestamptz(6)

  athletes        coaching_relationships[]
  programs        coaching_programs[]

  @@index([user_id])
}

/// Coach-Athlete relationship
model coaching_relationships {
  id           String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  coach_id     String                       @db.Uuid
  coach        coach_profiles               @relation(fields: [coach_id], references: [id], onDelete: Cascade)
  athlete_id   String                       @db.Uuid
  athlete      profiles                     @relation("AthleteCoaching", fields: [athlete_id], references: [id], onDelete: Cascade)
  status       coaching_relationship_status @default(PENDING)
  invited_at   DateTime                     @default(now()) @db.Timestamptz(6)
  accepted_at  DateTime?                    @db.Timestamptz(6)
  ended_at     DateTime?                    @db.Timestamptz(6)
  coach_notes  String?

  assignments  coaching_program_assignments[]

  @@unique([coach_id, athlete_id])
  @@index([coach_id])
  @@index([athlete_id])
  @@index([status])
}

/// Training program template/assignment
model coaching_programs {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  coach_id       String          @db.Uuid
  coach          coach_profiles  @relation(fields: [coach_id], references: [id], onDelete: Cascade)
  name           String
  description    String?
  duration_weeks Int
  difficulty     String?         // beginner, intermediate, advanced
  goal           String?         // strength, hypertrophy, endurance, general
  is_template    Boolean         @default(false)
  created_at     DateTime        @default(now()) @db.Timestamptz(6)
  updated_at     DateTime        @default(now()) @db.Timestamptz(6)

  weeks          coaching_program_weeks[]
  assignments    coaching_program_assignments[]

  @@index([coach_id])
  @@index([is_template])
}

/// Program assigned to specific athlete
model coaching_program_assignments {
  id              String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  program_id      String                 @db.Uuid
  program         coaching_programs      @relation(fields: [program_id], references: [id], onDelete: Cascade)
  relationship_id String                 @db.Uuid
  relationship    coaching_relationships @relation(fields: [relationship_id], references: [id], onDelete: Cascade)
  start_date      DateTime               @db.Date
  current_week    Int                    @default(1)
  status          String                 @default("active") // active, completed, paused
  created_at      DateTime               @default(now()) @db.Timestamptz(6)
  updated_at      DateTime               @default(now()) @db.Timestamptz(6)

  completions     coaching_workout_completions[]

  @@index([relationship_id])
  @@index([program_id])
  @@index([status])
}

/// Week within a program
model coaching_program_weeks {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  program_id  String            @db.Uuid
  program     coaching_programs @relation(fields: [program_id], references: [id], onDelete: Cascade)
  week_number Int
  name        String?           // "Deload Week", "Volume Block"
  notes       String?

  workouts    coaching_workouts[]

  @@unique([program_id, week_number])
  @@index([program_id])
}

/// Prescribed workout for a day
model coaching_workouts {
  id          String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  week_id     String                 @db.Uuid
  week        coaching_program_weeks @relation(fields: [week_id], references: [id], onDelete: Cascade)
  day_number  Int                    // 1-7
  name        String                 // "Push Day", "Upper A"
  notes       String?
  rest_day    Boolean                @default(false)

  exercises   coaching_workout_exercises[]
  completions coaching_workout_completions[]

  @@unique([week_id, day_number])
  @@index([week_id])
}

/// Prescribed exercise within a workout
model coaching_workout_exercises {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workout_id    String            @db.Uuid
  workout       coaching_workouts @relation(fields: [workout_id], references: [id], onDelete: Cascade)
  exercise_id   String            // From fitness exercise library
  exercise_name String            // Denormalized for display
  order_index   Int
  sets          Int
  reps_min      Int
  reps_max      Int?              // For ranges like "8-12"
  intensity     String?           // "75%", "RPE 8", "moderate"
  rest_seconds  Int?
  notes         String?

  @@unique([workout_id, order_index])
  @@index([workout_id])
}

/// Track athlete's completion of prescribed workouts
model coaching_workout_completions {
  id                    String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  assignment_id         String                       @db.Uuid
  assignment            coaching_program_assignments @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
  prescribed_workout_id String                       @db.Uuid
  prescribed_workout    coaching_workouts            @relation(fields: [prescribed_workout_id], references: [id], onDelete: Cascade)
  athlete_workout_id    String?                      // ID from gamify_fitness_data workouts array
  scheduled_date        DateTime                     @db.Date
  completed_at          DateTime?                    @db.Timestamptz(6)
  skipped               Boolean                      @default(false)
  compliance_score      Float?                       // 0-100
  coach_feedback        String?
  athlete_notes         String?

  @@unique([assignment_id, prescribed_workout_id, scheduled_date])
  @@index([assignment_id])
  @@index([scheduled_date])
}

// ============================================
// GAMIFICATION: DAILY REWARDS & INVENTORY
// ============================================

/// Track daily login reward claims
model daily_login_claims {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String   @db.Uuid
  user        profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)
  claim_date  DateTime @db.Date
  day_number  Int      // 1-7 for weekly cycle, 1-28 for monthly
  xp_earned   Int      @default(0)
  bonus_items Json?    // Array of item codes earned (streak shields, etc.)
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  @@unique([user_id, claim_date])
  @@index([user_id])
  @@index([claim_date])
}

enum item_rarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum item_type {
  CONSUMABLE    // One-time use items (XP boost, streak shield)
  COSMETIC      // Permanent unlocks (avatar items, themes)
  PET           // Pet companions
  CURRENCY      // Gold coins, gems, etc.
}

/// Definition of all available items
model inventory_items {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String      @unique  // 'streak_shield', 'xp_boost_2x', 'golden_frame'
  name        String
  description String?
  type        item_type
  rarity      item_rarity @default(COMMON)
  icon        String?     // Emoji or image URL
  effects     Json?       // { "streak_protection": 1, "xp_multiplier": 2.0 }
  stackable   Boolean     @default(true)
  max_stack   Int?        // null = unlimited
  tradeable   Boolean     @default(false)
  created_at  DateTime    @default(now()) @db.Timestamptz(6)

  user_inventory user_inventory[]

  @@index([type])
  @@index([rarity])
}

/// User's inventory of items
model user_inventory {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String          @db.Uuid
  user        profiles        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  item_id     String          @db.Uuid
  item        inventory_items @relation(fields: [item_id], references: [id], onDelete: Cascade)
  quantity    Int             @default(1)
  acquired_at DateTime        @default(now()) @db.Timestamptz(6)
  expires_at  DateTime?       @db.Timestamptz(6) // For time-limited items
  source      String?         // 'daily_reward', 'loot_drop', 'purchase', 'achievement'

  @@unique([user_id, item_id])
  @@index([user_id])
  @@index([item_id])
}
