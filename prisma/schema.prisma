generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// PERMISSIONS & SUBSCRIPTIONS
// ============================================

enum user_role {
  USER
  ADMIN
}

enum subscription_tier {
  FREE
  PREMIUM
  COACH
  PRO
}

enum subscription_status {
  ACTIVE
  TRIAL
  CANCELLED
  EXPIRED
  PAUSED
}

/// Global user roles (admin, user)
model user_roles {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @unique @db.Uuid
  user       profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role       user_role @default(USER)
  granted_at DateTime  @default(now()) @db.Timestamptz(6)
  granted_by String?   @db.Uuid

  @@index([user_id])
  @@index([role])
}

/// Per-app subscriptions/tiers
model user_subscriptions {
  id                     String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                String              @db.Uuid
  user                   profiles            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  app_id                 String              // 'fitness', 'today', 'travel', 'global'
  tier                   subscription_tier   @default(FREE)
  status                 subscription_status @default(ACTIVE)
  features               String[]            @default([]) // Additional feature flags
  started_at             DateTime            @default(now()) @db.Timestamptz(6)
  expires_at             DateTime?           @db.Timestamptz(6)
  trial_ends_at          DateTime?           @db.Timestamptz(6)
  stripe_subscription_id String?
  stripe_customer_id     String?
  cancelled_at           DateTime?           @db.Timestamptz(6)
  created_at             DateTime            @default(now()) @db.Timestamptz(6)
  updated_at             DateTime            @default(now()) @db.Timestamptz(6)

  @@unique([user_id, app_id])
  @@index([user_id])
  @@index([app_id])
  @@index([tier])
  @@index([status])
}

/// Feature definitions per app (for documentation and admin)
model app_features {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  app_id      String            // 'fitness', 'today', 'travel', 'global'
  feature_key String            // 'unlimited_templates', 'client_management'
  name        String
  description String?
  min_tier    subscription_tier @default(FREE)
  created_at  DateTime          @default(now()) @db.Timestamptz(6)

  @@unique([app_id, feature_key])
  @@index([app_id])
  @@index([min_tier])
}

// ============================================
// UNIFIED CORE TABLES (existing)
// ============================================

/// Global user profile - shared across all apps
model profiles {
  id                 String              @id @db.Uuid
  email              String              @unique
  username           String?             @unique
  display_name       String?
  avatar_url         String?
  bio                String?
  total_xp           Int?                @default(0)
  main_level         Int?                @default(1)
  current_streak     Int?                @default(0)
  longest_streak     Int?                @default(0)
  last_activity_date DateTime?           @db.Date

  // Gamification: Streak Protection & Daily Rewards
  streak_shields     Int?                @default(0)  // Number of streak shields available
  login_streak       Int?                @default(0)  // Consecutive days claiming login reward
  last_login_claim   DateTime?           @db.Date     // Last date login reward was claimed

  // XP Boost
  xp_boost_multiplier Float?              @default(1.0)  // Current XP multiplier (e.g., 2.0 for 2x)
  xp_boost_expires_at DateTime?           @db.Timestamptz(6)  // When the boost expires

  legacy_prisma_id   String?
  legacy_clerk_id    String?
  created_at         DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?           @default(now()) @db.Timestamptz(6)

  // Relations
  app_profiles       app_profiles[]
  user_achievements  user_achievements[]
  daily_login_claims daily_login_claims[]
  user_inventory     user_inventory[]

  // Travel relations
  travel_states        travel_states[]
  travel_cities        travel_cities[]
  travel_neighborhoods travel_neighborhoods[]
  travel_locations     travel_locations[]
  travel_visits        travel_visits[]
  travel_photos        travel_photos[]
  travel_reviews       travel_reviews[]
  travel_quests        travel_quests[]
  travel_user_location_data travel_user_location_data[]

  // Quest item attribution
  quest_items_added     travel_quest_items[] @relation("QuestItemAddedBy")
  quest_items_completed travel_quest_items[] @relation("QuestItemCompletedBy")

  // Social relations
  friendships_sent     friendships[] @relation("FriendshipRequester")
  friendships_received friendships[] @relation("FriendshipAddressee")
  party_memberships    quest_party_members[]
  activity_feed_owned  activity_feed[] @relation("ActivityFeedOwner")
  activity_feed_actor  activity_feed[] @relation("ActivityFeedActor")
  activity_kudos_given activity_kudos[] @relation("ActivityKudosGiver")
  activity_comments    activity_comments[] @relation("ActivityCommentAuthor")
  workout_props_given  workout_props[] @relation("WorkoutPropsGiver")

  // Coaching relations
  coach_profile        coach_profiles?
  coached_by           coaching_relationships[] @relation("AthleteCoaching")

  // Permission relations
  user_role            user_roles?
  subscriptions        user_subscriptions[]

  // Challenge relations
  challenges_created   challenges[]              @relation("ChallengeCreator")
  challenge_participations challenge_participants[] @relation("ChallengeParticipant")

  // Accountability relations
  accountability_sent     accountability_partnerships[] @relation("AccountabilityRequester")
  accountability_received accountability_partnerships[] @relation("AccountabilityPartner")
  partnership_checkins    partnership_checkins[]        @relation("PartnershipCheckinAuthor")
  nudges_sent             partnership_nudges[]          @relation("PartnershipNudgeSender")
  nudges_received         partnership_nudges[]          @relation("PartnershipNudgeRecipient")

  // Life Quest relations
  life_quests             life_quests[]

  // Coaching messaging relations
  athlete_conversations   coaching_conversations[] @relation("AthleteConversations")
  messages_sent           coaching_messages[]      @relation("MessageSender")

  // Coaching notification relations
  notifications_received  coaching_notifications[] @relation("NotificationRecipient")
  notifications_sent      coaching_notifications[] @relation("NotificationSender")

  // Coaching group and check-in relations
  group_memberships       coaching_group_members[] @relation("GroupMembership")
  check_ins               coaching_check_ins[]     @relation("AthleteCheckIns")

  @@index([email], map: "idx_profiles_email")
  @@index([username], map: "idx_profiles_username")
}

/// Per-app XP and level tracking
model app_profiles {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  app_id     String    // 'travel', 'fitness', 'today'
  xp         Int?      @default(0)
  level      Int?      @default(1)
  xp_to_next Int?      @default(100)
  stats      Json?     @default("{}")
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  profiles   profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, app_id])
  @@index([app_id], map: "idx_app_profiles_app_id")
  @@index([user_id], map: "idx_app_profiles_user_id")
}

/// Unified achievements across all apps
model achievements {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code              String              @unique
  app_id            String              // 'travel', 'fitness', 'today', 'global'
  name              String
  description       String
  icon              String?
  xp_reward         Int?                @default(0)
  category          String
  tier              Int?                @default(1)
  criteria          Json                @default("{}")
  created_at        DateTime?           @default(now()) @db.Timestamptz(6)

  user_achievements user_achievements[]

  @@index([app_id], map: "idx_achievements_app_id")
}

/// User achievement progress and completion
model user_achievements {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String       @db.Uuid
  achievement_id String       @db.Uuid
  progress       Int?         @default(0)
  is_completed   Boolean?     @default(false)
  completed_at   DateTime?    @db.Timestamptz(6)
  created_at     DateTime?    @default(now()) @db.Timestamptz(6)

  achievements   achievements @relation(fields: [achievement_id], references: [id], onDelete: Cascade)
  profiles       profiles     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, achievement_id])
  @@index([user_id], map: "idx_user_achievements_user_id")
}

/// Generic user data storage (for today app)
model user_data {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?   @unique @db.Uuid
  data       Json
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// Today app specific data
model gamify_today_data {
  user_id    String    @id @db.Uuid
  data       Json      @default("{}")
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// Fitness app specific data
model gamify_fitness_data {
  user_id    String    @id @db.Uuid
  data       Json      @default("{}")
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// Props/kudos on friends' workouts
model workout_props {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workout_key String   // Format: "userId:workoutId" (composite key for workout)
  giver_id    String   @db.Uuid
  giver       profiles @relation("WorkoutPropsGiver", fields: [giver_id], references: [id], onDelete: Cascade)
  emoji       String   @default("ðŸ”¥")
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  @@unique([workout_key, giver_id])
  @@index([workout_key])
  @@index([giver_id])
}

// ============================================
// TRAVEL APP TABLES
// ============================================

model travel_states {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  country       String
  country_code  String?
  abbreviation  String?
  latitude      Float?
  longitude     Float?

  user_id       String    @db.Uuid
  user          profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  cities        travel_cities[]

  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @default(now()) @db.Timestamptz(6)

  @@unique([user_id, name, country])
  @@index([user_id])
  @@index([country])
}

model travel_cities {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  country       String
  region        String?
  country_code  String?
  latitude      Float?
  longitude     Float?
  first_visited DateTime? @db.Timestamptz(6)
  last_visited  DateTime? @db.Timestamptz(6)
  visit_count   Int       @default(1)
  notes         String?
  location_count Int      @default(0)

  user_id       String    @db.Uuid
  user          profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  state_id      String?   @db.Uuid
  state         travel_states? @relation(fields: [state_id], references: [id], onDelete: SetNull)

  neighborhoods travel_neighborhoods[]
  locations     travel_locations[]
  quests        travel_quests[]
  quest_cities  travel_quest_cities[]

  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @default(now()) @db.Timestamptz(6)

  @@unique([user_id, name, country])
  @@index([user_id])
  @@index([country])
  @@index([state_id])
}

model travel_neighborhoods {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  latitude    Float?
  longitude   Float?

  user_id     String     @db.Uuid
  user        profiles   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  city_id     String     @db.Uuid
  city        travel_cities @relation(fields: [city_id], references: [id], onDelete: Cascade)

  locations           travel_locations[]
  quests              travel_quests[]
  quest_neighborhoods travel_quest_neighborhoods[]

  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  updated_at  DateTime   @default(now()) @db.Timestamptz(6)

  @@unique([user_id, city_id, name])
  @@index([user_id])
  @@index([city_id])
}

enum travel_location_type {
  RESTAURANT
  BAR
  CAFE
  ATTRACTION
  HOTEL
  SHOP
  NATURE
  TRANSPORT
  MUSEUM
  BEACH
  NIGHTLIFE
  OTHER
}

model travel_locations {
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  type           travel_location_type
  cuisine        String?
  address        String?
  latitude       Float
  longitude      Float
  blurb          String?
  description    String?
  website        String?
  phone          String?
  hours          String?
  price_level    Int?
  other_info     String?
  visited        Boolean             @default(false)
  hotlist        Boolean             @default(false)
  tags           String[]

  // Aggregate stats
  avg_rating     Float?
  rating_count   Int                 @default(0)
  review_count   Int                 @default(0)
  total_visits   Int                 @default(0)

  // External source tracking (for seeded/imported locations)
  external_id     String?
  external_source String?            // 'foursquare', 'google', 'osm', 'manual'

  // Owner/creator
  user_id        String?             @db.Uuid
  user           profiles?           @relation(fields: [user_id], references: [id], onDelete: SetNull)

  city_id        String              @db.Uuid
  city           travel_cities       @relation(fields: [city_id], references: [id], onDelete: Cascade)
  neighborhood_id String?            @db.Uuid
  neighborhood   travel_neighborhoods? @relation(fields: [neighborhood_id], references: [id], onDelete: SetNull)

  visits         travel_visits[]
  photos         travel_photos[]
  user_data      travel_user_location_data[]
  reviews        travel_reviews[]
  quest_items    travel_quest_items[]

  created_at     DateTime            @default(now()) @db.Timestamptz(6)
  updated_at     DateTime            @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([city_id])
  @@index([neighborhood_id])
  @@index([type])
  @@index([latitude, longitude])
  // Compound indexes for common query patterns
  @@index([user_id, city_id])
  @@index([user_id, type])
  @@index([user_id, visited])
  @@index([user_id, hotlist])
  @@unique([external_id, external_source])
}

model travel_visits {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date            DateTime         @db.Timestamptz(6)
  overall_rating  Float?
  food_quality    Int?
  service_rating  Int?
  ambiance_rating Int?
  value_rating    Int?
  notes           String?
  highlights      String[]
  xp_earned       Int              @default(0)

  user_id         String           @db.Uuid
  user            profiles         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location_id     String           @db.Uuid
  location        travel_locations @relation(fields: [location_id], references: [id], onDelete: Cascade)

  photos          travel_photos[]

  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([location_id])
  @@index([date])
}

model travel_photos {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  url         String
  caption     String?

  user_id     String            @db.Uuid
  user        profiles          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location_id String?           @db.Uuid
  location    travel_locations? @relation(fields: [location_id], references: [id], onDelete: Cascade)
  visit_id    String?           @db.Uuid
  visit       travel_visits?    @relation(fields: [visit_id], references: [id], onDelete: Cascade)

  created_at  DateTime          @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([location_id])
  @@index([visit_id])
}

/// Per-user data for each location (hotlist, personal notes, etc.)
model travel_user_location_data {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hotlist         Boolean          @default(false)
  visited         Boolean          @default(false)
  personal_rating Float?
  notes           String?
  visit_count     Int              @default(0)
  first_visited_at DateTime?       @db.Timestamptz(6)
  last_visited_at  DateTime?       @db.Timestamptz(6)

  user_id         String           @db.Uuid
  user            profiles         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location_id     String           @db.Uuid
  location        travel_locations @relation(fields: [location_id], references: [id], onDelete: Cascade)

  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @default(now()) @db.Timestamptz(6)

  @@unique([user_id, location_id])
  @@index([user_id])
  @@index([location_id])
  // Compound indexes for filtering user's locations
  @@index([user_id, visited])
  @@index([user_id, hotlist])
}

enum travel_review_status {
  PENDING
  APPROVED
  REJECTED
}

model travel_reviews {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title           String?
  content         String
  rating          Float
  status          travel_review_status @default(PENDING)
  moderated_at    DateTime?           @db.Timestamptz(6)
  moderated_by    String?
  food_quality    Int?
  service_rating  Int?
  ambiance_rating Int?
  value_rating    Int?

  author_id       String              @db.Uuid
  author          profiles            @relation(fields: [author_id], references: [id], onDelete: Cascade)
  location_id     String              @db.Uuid
  location        travel_locations    @relation(fields: [location_id], references: [id], onDelete: Cascade)

  created_at      DateTime            @default(now()) @db.Timestamptz(6)
  updated_at      DateTime            @default(now()) @db.Timestamptz(6)

  @@index([author_id])
  @@index([location_id])
  @@index([status])
}

enum travel_quest_status {
  PLANNING
  ACTIVE
  COMPLETED
  ARCHIVED
}

model travel_quests {
  id                     String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String
  description            String?
  target_city_id         String?               @db.Uuid
  target_city            travel_cities?        @relation(fields: [target_city_id], references: [id], onDelete: SetNull)
  target_neighborhood_id String?               @db.Uuid
  target_neighborhood    travel_neighborhoods? @relation(fields: [target_neighborhood_id], references: [id], onDelete: SetNull)
  start_date             DateTime?             @db.Timestamptz(6)
  end_date               DateTime?             @db.Timestamptz(6)
  status                 travel_quest_status   @default(PLANNING)

  user_id                String                @db.Uuid
  user                   profiles              @relation(fields: [user_id], references: [id], onDelete: Cascade)

  items                  travel_quest_items[]
  party                  quest_parties?

  // Multi-city/neighborhood support
  cities                 travel_quest_cities[]
  neighborhoods          travel_quest_neighborhoods[]

  created_at             DateTime              @default(now()) @db.Timestamptz(6)
  updated_at             DateTime              @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([status])
  @@index([target_city_id])
  @@index([target_neighborhood_id])
}

model travel_quest_items {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  completed    Boolean          @default(false)
  completed_at DateTime?        @db.Timestamptz(6)
  sort_order   Int              @default(0)
  priority     Int              @default(0)
  notes        String?

  quest_id     String           @db.Uuid
  quest        travel_quests    @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  location_id  String           @db.Uuid
  location     travel_locations @relation(fields: [location_id], references: [id], onDelete: Cascade)

  // Party attribution
  added_by_id     String?       @db.Uuid
  added_by        profiles?     @relation("QuestItemAddedBy", fields: [added_by_id], references: [id], onDelete: SetNull)
  completed_by_id String?       @db.Uuid
  completed_by    profiles?     @relation("QuestItemCompletedBy", fields: [completed_by_id], references: [id], onDelete: SetNull)

  @@unique([quest_id, location_id])
  @@index([quest_id])
  @@index([location_id])
}

/// Multi-city support for quests (junction table)
model travel_quest_cities {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id   String        @db.Uuid
  quest      travel_quests @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  city_id    String        @db.Uuid
  city       travel_cities @relation(fields: [city_id], references: [id], onDelete: Cascade)
  sort_order Int           @default(0)

  @@unique([quest_id, city_id])
  @@index([quest_id])
  @@index([city_id])
}

/// Multi-neighborhood support for quests (junction table)
model travel_quest_neighborhoods {
  id              String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id        String               @db.Uuid
  quest           travel_quests        @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  neighborhood_id String               @db.Uuid
  neighborhood    travel_neighborhoods @relation(fields: [neighborhood_id], references: [id], onDelete: Cascade)

  @@unique([quest_id, neighborhood_id])
  @@index([quest_id])
  @@index([neighborhood_id])
}

// ============================================
// SOCIAL SYSTEM TABLES (Platform-wide)
// ============================================

enum friendship_status {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

/// Platform-wide friendship relationships (bidirectional)
model friendships {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requester_id String            @db.Uuid
  requester    profiles          @relation("FriendshipRequester", fields: [requester_id], references: [id], onDelete: Cascade)
  addressee_id String            @db.Uuid
  addressee    profiles          @relation("FriendshipAddressee", fields: [addressee_id], references: [id], onDelete: Cascade)
  status       friendship_status @default(PENDING)
  created_at   DateTime          @default(now()) @db.Timestamptz(6)
  accepted_at  DateTime?         @db.Timestamptz(6)

  @@unique([requester_id, addressee_id])
  @@index([requester_id])
  @@index([addressee_id])
  @@index([status])
}

enum party_member_role {
  OWNER
  MEMBER
}

enum party_invite_status {
  PENDING
  ACCEPTED
  DECLINED
}

/// Party for collaborative quest editing (1:1 with quest)
model quest_parties {
  id         String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id   String                @unique @db.Uuid
  quest      travel_quests         @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  created_at DateTime              @default(now()) @db.Timestamptz(6)

  members    quest_party_members[]

  @@index([quest_id])
}

/// Party membership associations
model quest_party_members {
  id         String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  party_id   String              @db.Uuid
  party      quest_parties       @relation(fields: [party_id], references: [id], onDelete: Cascade)
  user_id    String              @db.Uuid
  user       profiles            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role       party_member_role   @default(MEMBER)
  status     party_invite_status @default(PENDING)
  invited_at DateTime            @default(now()) @db.Timestamptz(6)
  joined_at  DateTime?           @db.Timestamptz(6)

  @@unique([party_id, user_id])
  @@index([party_id])
  @@index([user_id])
  @@index([status])
}

enum activity_type {
  FRIEND_REQUEST_RECEIVED
  FRIEND_REQUEST_ACCEPTED
  PARTY_INVITE_RECEIVED
  PARTY_MEMBER_JOINED
  QUEST_ITEM_ADDED
  QUEST_ITEM_COMPLETED
  QUEST_COMPLETED
  COMMENT
  KUDOS
}

/// Activity feed for social notifications
model activity_feed {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String        @db.Uuid  // Target user (who should see this)
  user        profiles      @relation("ActivityFeedOwner", fields: [user_id], references: [id], onDelete: Cascade)
  actor_id    String        @db.Uuid  // Who performed the action
  actor       profiles      @relation("ActivityFeedActor", fields: [actor_id], references: [id], onDelete: Cascade)
  type        activity_type
  entity_type String?                 // 'quest', 'location', 'friendship'
  entity_id   String?       @db.Uuid  // ID of the related entity
  metadata    Json          @default("{}")
  read        Boolean       @default(false)
  created_at  DateTime      @default(now()) @db.Timestamptz(6)
  kudos       activity_kudos[]
  comments    activity_comments[]

  @@index([user_id, read])
  @@index([user_id, created_at])
  @@index([actor_id])
}

/// Kudos/reactions on activity feed items
model activity_kudos {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  activity_id String       @db.Uuid
  activity    activity_feed @relation(fields: [activity_id], references: [id], onDelete: Cascade)
  user_id     String       @db.Uuid
  user        profiles     @relation("ActivityKudosGiver", fields: [user_id], references: [id], onDelete: Cascade)
  emoji       String       @default("ðŸ”¥")  // Fire, thumbs up, etc.
  created_at  DateTime     @default(now()) @db.Timestamptz(6)

  @@unique([activity_id, user_id])
  @@index([activity_id])
  @@index([user_id])
}

/// Comments on activity feed items
model activity_comments {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  activity_id String        @db.Uuid
  activity    activity_feed @relation(fields: [activity_id], references: [id], onDelete: Cascade)
  user_id     String        @db.Uuid
  user        profiles      @relation("ActivityCommentAuthor", fields: [user_id], references: [id], onDelete: Cascade)
  content     String        @db.VarChar(500)
  created_at  DateTime      @default(now()) @db.Timestamptz(6)
  updated_at  DateTime      @default(now()) @db.Timestamptz(6)

  @@index([activity_id])
  @@index([user_id])
  @@index([created_at])
}

// ============================================
// CHALLENGES SYSTEM
// ============================================

enum challenge_status {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum challenge_type {
  FITNESS_WORKOUTS      // Most workouts completed
  FITNESS_VOLUME        // Total volume lifted
  FITNESS_XP            // Most XP earned
  TRAVEL_LOCATIONS      // Most locations visited
  TRAVEL_CITIES         // Most cities explored
  TODAY_HABITS          // Habit completion rate
  TODAY_STREAK          // Longest streak
  CUSTOM                // Custom metric
}

/// Time-limited challenges between friends
model challenges {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  creator_id   String           @db.Uuid
  creator      profiles         @relation("ChallengeCreator", fields: [creator_id], references: [id], onDelete: Cascade)
  title        String
  description  String?
  type         challenge_type
  app_id       String           // 'fitness', 'travel', 'today'
  metric       String           // Specific metric to track
  target       Int?             // Optional target value
  start_date   DateTime         @db.Timestamptz(6)
  end_date     DateTime         @db.Timestamptz(6)
  status       challenge_status @default(DRAFT)
  xp_reward    Int              @default(100)
  icon         String?          // Emoji for the challenge
  created_at   DateTime         @default(now()) @db.Timestamptz(6)
  updated_at   DateTime         @default(now()) @db.Timestamptz(6)

  participants challenge_participants[]

  @@index([creator_id])
  @@index([status])
  @@index([start_date])
  @@index([end_date])
  @@index([app_id])
}

enum challenge_participant_status {
  INVITED
  JOINED
  DECLINED
  LEFT
}

/// Challenge participation and scores
model challenge_participants {
  id           String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  challenge_id String                       @db.Uuid
  challenge    challenges                   @relation(fields: [challenge_id], references: [id], onDelete: Cascade)
  user_id      String                       @db.Uuid
  user         profiles                     @relation("ChallengeParticipant", fields: [user_id], references: [id], onDelete: Cascade)
  status       challenge_participant_status @default(INVITED)
  score        Float                        @default(0)
  rank         Int?
  last_updated DateTime                     @default(now()) @db.Timestamptz(6)
  joined_at    DateTime?                    @db.Timestamptz(6)
  created_at   DateTime                     @default(now()) @db.Timestamptz(6)

  @@unique([challenge_id, user_id])
  @@index([challenge_id])
  @@index([user_id])
  @@index([status])
  @@index([score])
}

// ============================================
// ACCOUNTABILITY PARTNERS SYSTEM
// ============================================

enum accountability_status {
  PENDING
  ACTIVE
  PAUSED
  ENDED
}

/// Accountability partnerships between two users
model accountability_partnerships {
  id           String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requester_id String               @db.Uuid
  requester    profiles             @relation("AccountabilityRequester", fields: [requester_id], references: [id], onDelete: Cascade)
  partner_id   String               @db.Uuid
  partner      profiles             @relation("AccountabilityPartner", fields: [partner_id], references: [id], onDelete: Cascade)
  status       accountability_status @default(PENDING)
  message      String?              // Initial message when requesting
  started_at   DateTime?            @db.Timestamptz(6)
  ended_at     DateTime?            @db.Timestamptz(6)
  created_at   DateTime             @default(now()) @db.Timestamptz(6)
  updated_at   DateTime             @default(now()) @db.Timestamptz(6)

  goals    partnership_goals[]
  checkins partnership_checkins[]
  nudges   partnership_nudges[]

  @@unique([requester_id, partner_id])
  @@index([requester_id])
  @@index([partner_id])
  @@index([status])
}

enum goal_type {
  WORKOUT_FREQUENCY    // X workouts per week
  HABIT_STREAK         // Maintain X day streak
  LOCATION_VISITS      // Visit X places
  DAILY_COMPLETION     // Complete daily tasks
  CUSTOM               // Custom goal
}

/// Shared goals within a partnership
model partnership_goals {
  id             String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnership_id String                       @db.Uuid
  partnership    accountability_partnerships  @relation(fields: [partnership_id], references: [id], onDelete: Cascade)
  type           goal_type
  title          String
  description    String?
  target         Int                          // Target value
  current_user1  Int                          @default(0) // Requester's progress
  current_user2  Int                          @default(0) // Partner's progress
  period         String                       @default("week") // 'day', 'week', 'month'
  deadline       DateTime?                    @db.Timestamptz(6)
  active         Boolean                      @default(true)
  created_at     DateTime                     @default(now()) @db.Timestamptz(6)
  updated_at     DateTime                     @default(now()) @db.Timestamptz(6)

  @@index([partnership_id])
  @@index([active])
}

/// Daily/weekly check-ins for partnerships
model partnership_checkins {
  id             String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnership_id String                      @db.Uuid
  partnership    accountability_partnerships @relation(fields: [partnership_id], references: [id], onDelete: Cascade)
  user_id        String                      @db.Uuid
  user           profiles                    @relation("PartnershipCheckinAuthor", fields: [user_id], references: [id], onDelete: Cascade)
  date           DateTime                    @db.Date
  completed      Boolean                     @default(true)
  notes          String?
  mood           Int?                        // 1-5 mood rating
  created_at     DateTime                    @default(now()) @db.Timestamptz(6)

  @@unique([partnership_id, user_id, date])
  @@index([partnership_id])
  @@index([user_id])
  @@index([date])
}

/// Nudges/reminders between partners
model partnership_nudges {
  id             String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partnership_id String                      @db.Uuid
  partnership    accountability_partnerships @relation(fields: [partnership_id], references: [id], onDelete: Cascade)
  sender_id      String                      @db.Uuid
  sender         profiles                    @relation("PartnershipNudgeSender", fields: [sender_id], references: [id], onDelete: Cascade)
  recipient_id   String                      @db.Uuid
  recipient      profiles                    @relation("PartnershipNudgeRecipient", fields: [recipient_id], references: [id], onDelete: Cascade)
  message        String?
  read           Boolean                     @default(false)
  created_at     DateTime                    @default(now()) @db.Timestamptz(6)

  @@index([partnership_id])
  @@index([recipient_id])
  @@index([read])
}

// ============================================
// FITNESS COACHING SYSTEM TABLES
// ============================================

enum coaching_relationship_status {
  PENDING
  ACTIVE
  PAUSED
  ENDED
}

/// Coach profile - extends user profile with coaching capabilities
model coach_profiles {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String    @unique @db.Uuid
  user            profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  business_name   String?
  specializations String[]  // ["powerlifting", "bodybuilding", "general fitness"]
  bio             String?
  is_verified     Boolean   @default(false)
  max_athletes    Int       @default(10)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @default(now()) @db.Timestamptz(6)

  athletes        coaching_relationships[]
  programs        coaching_programs[]
  templates       coaching_workout_templates[]
  conversations   coaching_conversations[]
  groups          coaching_groups[]
  check_ins       coaching_check_ins[]

  @@index([user_id])
}

/// Coach-Athlete relationship
model coaching_relationships {
  id           String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  coach_id     String                       @db.Uuid
  coach        coach_profiles               @relation(fields: [coach_id], references: [id], onDelete: Cascade)
  athlete_id   String                       @db.Uuid
  athlete      profiles                     @relation("AthleteCoaching", fields: [athlete_id], references: [id], onDelete: Cascade)
  status       coaching_relationship_status @default(PENDING)
  invited_at   DateTime                     @default(now()) @db.Timestamptz(6)
  accepted_at  DateTime?                    @db.Timestamptz(6)
  ended_at     DateTime?                    @db.Timestamptz(6)
  coach_notes  String?

  assignments  coaching_program_assignments[]

  @@unique([coach_id, athlete_id])
  @@index([coach_id])
  @@index([athlete_id])
  @@index([status])
}

/// Training program template/assignment
model coaching_programs {
  id                 String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  coach_id           String          @db.Uuid
  coach              coach_profiles  @relation(fields: [coach_id], references: [id], onDelete: Cascade)
  name               String
  description        String?
  duration_weeks     Int
  difficulty         String?         // beginner, intermediate, advanced
  goal               String?         // strength, hypertrophy, endurance, general (legacy)
  goal_priorities    Json?           // ["strength", "hypertrophy", "endurance", "general"] in priority order
  is_template        Boolean         @default(false)
  progression_config Json?           // Stores ProgressionConfig from types.ts
  created_at         DateTime        @default(now()) @db.Timestamptz(6)
  updated_at         DateTime        @default(now()) @db.Timestamptz(6)

  weeks              coaching_program_weeks[]
  assignments        coaching_program_assignments[]
  versions           coaching_program_versions[]

  @@index([coach_id])
  @@index([is_template])
}

/// Program assigned to specific athlete
model coaching_program_assignments {
  id              String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  program_id      String                 @db.Uuid
  program         coaching_programs      @relation(fields: [program_id], references: [id], onDelete: Cascade)
  relationship_id String                 @db.Uuid
  relationship    coaching_relationships @relation(fields: [relationship_id], references: [id], onDelete: Cascade)
  start_date      DateTime               @db.Date
  current_week    Int                    @default(1)
  status          String                 @default("active") // active, completed, paused
  created_at      DateTime               @default(now()) @db.Timestamptz(6)
  updated_at      DateTime               @default(now()) @db.Timestamptz(6)

  completions     coaching_workout_completions[]

  @@index([relationship_id])
  @@index([program_id])
  @@index([status])
}

/// Week within a program
model coaching_program_weeks {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  program_id  String            @db.Uuid
  program     coaching_programs @relation(fields: [program_id], references: [id], onDelete: Cascade)
  week_number Int
  name        String?           // "Deload Week", "Volume Block"
  notes       String?

  workouts    coaching_workouts[]

  @@unique([program_id, week_number])
  @@index([program_id])
}

/// Prescribed workout for a day
model coaching_workouts {
  id          String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  week_id     String                 @db.Uuid
  week        coaching_program_weeks @relation(fields: [week_id], references: [id], onDelete: Cascade)
  day_number  Int                    // 1-7
  name        String                 // "Push Day", "Upper A"
  notes       String?
  rest_day    Boolean                @default(false)

  exercises   coaching_workout_exercises[]
  completions coaching_workout_completions[]

  @@unique([week_id, day_number])
  @@index([week_id])
}

/// Prescribed exercise within a workout
model coaching_workout_exercises {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workout_id    String            @db.Uuid
  workout       coaching_workouts @relation(fields: [workout_id], references: [id], onDelete: Cascade)
  exercise_id   String            // From fitness exercise library
  exercise_name String            // Denormalized for display
  order_index   Int
  sets          Int
  reps_min      Int
  reps_max      Int?              // For ranges like "8-12"
  intensity     String?           // "75%", "RPE 8", "moderate"
  rest_seconds  Int?
  notes         String?

  @@unique([workout_id, order_index])
  @@index([workout_id])
}

/// Track athlete's completion of prescribed workouts
model coaching_workout_completions {
  id                    String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  assignment_id         String                       @db.Uuid
  assignment            coaching_program_assignments @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
  prescribed_workout_id String                       @db.Uuid
  prescribed_workout    coaching_workouts            @relation(fields: [prescribed_workout_id], references: [id], onDelete: Cascade)
  athlete_workout_id    String?                      // ID from gamify_fitness_data workouts array
  scheduled_date        DateTime                     @db.Date
  completed_at          DateTime?                    @db.Timestamptz(6)
  skipped               Boolean                      @default(false)
  compliance_score      Float?                       // 0-100
  coach_feedback        String?
  athlete_notes         String?

  @@unique([assignment_id, prescribed_workout_id, scheduled_date])
  @@index([assignment_id])
  @@index([scheduled_date])
}

/// Reusable workout templates for coaches
model coaching_workout_templates {
  id          String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  coach_id    String                        @db.Uuid
  coach       coach_profiles                @relation(fields: [coach_id], references: [id], onDelete: Cascade)
  name        String
  description String?
  is_public   Boolean                       @default(false)
  created_at  DateTime                      @default(now()) @db.Timestamptz(6)
  updated_at  DateTime                      @default(now()) @db.Timestamptz(6)

  exercises   coaching_template_exercises[]

  @@index([coach_id])
  @@index([is_public])
}

/// Exercises within a workout template
model coaching_template_exercises {
  id            String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  template_id   String                     @db.Uuid
  template      coaching_workout_templates @relation(fields: [template_id], references: [id], onDelete: Cascade)
  exercise_id   String
  exercise_name String
  order_index   Int
  sets          Int
  reps_min      Int
  reps_max      Int?
  intensity     String?
  rest_seconds  Int?
  notes         String?

  @@unique([template_id, order_index])
  @@index([template_id])
}

/// Version history for programs
model coaching_program_versions {
  id         String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  program_id String            @db.Uuid
  program    coaching_programs @relation(fields: [program_id], references: [id], onDelete: Cascade)
  version    Int
  snapshot   Json              // Full program state at time of save
  notes      String?           // "Added deload week", etc.
  created_by String            @db.Uuid
  created_at DateTime          @default(now()) @db.Timestamptz(6)

  @@unique([program_id, version])
  @@index([program_id])
}

// ============================================
// COACHING: MESSAGING
// ============================================

/// Coach-athlete conversation thread
model coaching_conversations {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  coach_id        String   @db.Uuid
  coach           coach_profiles @relation(fields: [coach_id], references: [id], onDelete: Cascade)
  athlete_id      String   @db.Uuid
  athlete         profiles @relation("AthleteConversations", fields: [athlete_id], references: [id], onDelete: Cascade)
  last_message_at DateTime @default(now()) @db.Timestamptz(6)
  coach_unread    Int      @default(0)
  athlete_unread  Int      @default(0)
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  messages        coaching_messages[]

  @@unique([coach_id, athlete_id])
  @@index([coach_id])
  @@index([athlete_id])
  @@index([last_message_at])
}

/// Individual messages in a conversation
model coaching_messages {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversation_id String   @db.Uuid
  conversation    coaching_conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  sender_id       String   @db.Uuid
  sender          profiles @relation("MessageSender", fields: [sender_id], references: [id], onDelete: Cascade)
  content         String
  attachments     Json?    // Array of { type: 'image'|'video', url: string, thumbnail?: string }
  read_at         DateTime? @db.Timestamptz(6)
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  @@index([conversation_id])
  @@index([sender_id])
  @@index([created_at])
}

// ============================================
// COACHING: NOTIFICATIONS
// ============================================

enum coaching_notification_type {
  WORKOUT_REMINDER      // Remind athlete to work out
  WORKOUT_COMPLETED     // Athlete completed a workout (for coach)
  PROGRAM_UPDATED       // Coach updated the program
  PROGRAM_ASSIGNED      // New program assigned to athlete
  COACH_MESSAGE         // New message from coach
  ATHLETE_MESSAGE       // New message from athlete (for coach)
  PR_CELEBRATION        // Athlete hit a new PR
  STREAK_WARNING        // Athlete about to lose streak
  CHECK_IN_DUE          // Weekly check-in reminder
  FORM_CHECK_READY      // Coach reviewed form check
}

/// Coaching notifications for coaches and athletes
model coaching_notifications {
  id           String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recipient_id String                      @db.Uuid
  recipient    profiles                    @relation("NotificationRecipient", fields: [recipient_id], references: [id], onDelete: Cascade)
  sender_id    String?                     @db.Uuid  // null for system notifications
  sender       profiles?                   @relation("NotificationSender", fields: [sender_id], references: [id], onDelete: SetNull)
  type         coaching_notification_type
  title        String
  body         String
  data         Json?                       // Additional context (athlete_id, workout_id, etc.)
  read         Boolean                     @default(false)
  read_at      DateTime?                   @db.Timestamptz(6)
  created_at   DateTime                    @default(now()) @db.Timestamptz(6)

  @@index([recipient_id])
  @@index([recipient_id, read])
  @@index([created_at])
}

// ============================================
// COACHING: GROUPS
// ============================================

/// Athlete groups for batch management
model coaching_groups {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  coach_id    String   @db.Uuid
  coach       coach_profiles @relation(fields: [coach_id], references: [id], onDelete: Cascade)
  name        String
  description String?
  color       String?  // Hex color for UI display
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  members     coaching_group_members[]

  @@index([coach_id])
}

/// Group membership (athlete can be in multiple groups)
model coaching_group_members {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  group_id   String   @db.Uuid
  group      coaching_groups @relation(fields: [group_id], references: [id], onDelete: Cascade)
  athlete_id String   @db.Uuid
  athlete    profiles @relation("GroupMembership", fields: [athlete_id], references: [id], onDelete: Cascade)
  joined_at  DateTime @default(now()) @db.Timestamptz(6)

  @@unique([group_id, athlete_id])
  @@index([group_id])
  @@index([athlete_id])
}

// ============================================
// COACHING: CHECK-INS
// ============================================

/// Weekly wellness check-ins from athletes
model coaching_check_ins {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  athlete_id   String   @db.Uuid
  athlete      profiles @relation("AthleteCheckIns", fields: [athlete_id], references: [id], onDelete: Cascade)
  coach_id     String   @db.Uuid
  coach        coach_profiles @relation(fields: [coach_id], references: [id], onDelete: Cascade)
  week_of      DateTime @db.Date  // Start of the week this check-in covers

  // Wellness metrics (1-5 scale)
  energy_level    Int?     // How energetic do you feel?
  sleep_quality   Int?     // How well did you sleep this week?
  stress_level    Int?     // How stressed are you? (inverted: 5=low stress)
  soreness_level  Int?     // How sore are you? (inverted: 5=not sore)
  motivation      Int?     // How motivated are you to train?

  // Freeform
  wins            String?  // What went well this week?
  challenges      String?  // What was challenging?
  questions       String?  // Questions for coach

  // Coach response
  coach_notes     String?
  reviewed_at     DateTime? @db.Timestamptz(6)

  created_at      DateTime @default(now()) @db.Timestamptz(6)

  @@unique([athlete_id, coach_id, week_of])
  @@index([athlete_id])
  @@index([coach_id])
  @@index([week_of])
}

// ============================================
// GAMIFICATION: DAILY REWARDS & INVENTORY
// ============================================

/// Track daily login reward claims
model daily_login_claims {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String   @db.Uuid
  user        profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)
  claim_date  DateTime @db.Date
  day_number  Int      // 1-7 for weekly cycle, 1-28 for monthly
  xp_earned   Int      @default(0)
  bonus_items Json?    // Array of item codes earned (streak shields, etc.)
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  @@unique([user_id, claim_date])
  @@index([user_id])
  @@index([claim_date])
}

enum item_rarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum item_type {
  CONSUMABLE    // One-time use items (XP boost, streak shield)
  COSMETIC      // Permanent unlocks (avatar items, themes)
  PET           // Pet companions
  CURRENCY      // Gold coins, gems, etc.
}

/// Definition of all available items
model inventory_items {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String      @unique  // 'streak_shield', 'xp_boost_2x', 'golden_frame'
  name        String
  description String?
  type        item_type
  rarity      item_rarity @default(COMMON)
  icon        String?     // Emoji or image URL
  effects     Json?       // { "streak_protection": 1, "xp_multiplier": 2.0 }
  stackable   Boolean     @default(true)
  max_stack   Int?        // null = unlimited
  tradeable   Boolean     @default(false)
  created_at  DateTime    @default(now()) @db.Timestamptz(6)

  user_inventory user_inventory[]

  @@index([type])
  @@index([rarity])
}

/// User's inventory of items
model user_inventory {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String          @db.Uuid
  user        profiles        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  item_id     String          @db.Uuid
  item        inventory_items @relation(fields: [item_id], references: [id], onDelete: Cascade)
  quantity    Int             @default(1)
  acquired_at DateTime        @default(now()) @db.Timestamptz(6)
  expires_at  DateTime?       @db.Timestamptz(6) // For time-limited items
  source      String?         // 'daily_reward', 'loot_drop', 'purchase', 'achievement'

  @@unique([user_id, item_id])
  @@index([user_id])
  @@index([item_id])
}

// ============================================
// LIFE QUESTS - Universal Goal Gamification
// ============================================

enum life_quest_type {
  COUNTING      // "Read 52 books" - divide into time periods
  COLLECTION    // "Try every hot dog brand" - checklist tracking
  ACHIEVEMENT   // "Get an A in calculus" - milestone-based
  HABIT         // "Meditate daily" - streak-based
  PROJECT       // "Launch my startup" - dependency-based tasks
  FITNESS       // "Run a marathon" - progressive training
  LEARNING      // "Learn Spanish" - skill tree progression
}

enum journey_stage {
  CALLING       // 0% - Quest accepted, commitment made
  THRESHOLD     // 1-24% - First steps taken
  TESTS         // 25-49% - Challenges emerge
  ORDEAL        // 50-74% - The hard middle, "the slog"
  REWARD        // 75-99% - Breakthrough moment
  RETURN        // 100% - Mastery achieved
}

enum life_quest_status {
  PLANNING
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

enum task_difficulty {
  EASY
  MEDIUM
  HARD
  EPIC
}

/// Universal quest that spans any life goal
model life_quests {
  id                 String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String            @db.Uuid
  user               profiles          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Quest definition
  title              String
  description        String?
  original_goal      String            // User's natural language input
  quest_type         life_quest_type

  // Hero's Journey tracking
  journey_stage      journey_stage     @default(CALLING)

  // Narrative elements
  narrator_type      String?           // 'sage', 'coach', 'explorer', 'strategist'
  story_hook         String?           // Opening narrative
  quest_icon         String?           // Emoji or icon code

  // Progress
  status             life_quest_status @default(ACTIVE)
  progress_percent   Int               @default(0)

  // For counting quests
  target_count       Int?              // Total goal (e.g., 52 books)
  current_count      Int               @default(0)
  count_unit         String?           // "books", "workouts", "items"

  // Scheduling
  start_date         DateTime?         @db.Timestamptz(6)
  target_date        DateTime?         @db.Timestamptz(6)
  recurrence_rule    Json?             // { frequency: 'weekly', target: 1 }

  // XP tracking
  total_xp_available Int               @default(0)
  xp_earned          Int               @default(0)

  // Cross-app integration (optional)
  linked_app         String?           // 'fitness', 'travel', 'today', null for standalone

  // AI generation tracking
  ai_generated       Boolean           @default(false)
  template_id        String?           @db.Uuid

  created_at         DateTime          @default(now()) @db.Timestamptz(6)
  updated_at         DateTime          @default(now()) @db.Timestamptz(6)
  completed_at       DateTime?         @db.Timestamptz(6)

  // Relations
  milestones         life_quest_milestones[]
  tasks              life_quest_tasks[]
  logs               life_quest_logs[]
  template           life_quest_templates? @relation(fields: [template_id], references: [id])

  @@index([user_id, status])
  @@index([user_id, quest_type])
  @@index([journey_stage])
}

/// Milestones representing Hero's Journey stages
model life_quest_milestones {
  id                 String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id           String        @db.Uuid
  quest              life_quests   @relation(fields: [quest_id], references: [id], onDelete: Cascade)

  title              String
  description        String?
  journey_stage      journey_stage // Which Hero's Journey stage

  // Progress
  sort_order         Int
  is_completed       Boolean       @default(false)
  completed_at       DateTime?     @db.Timestamptz(6)

  // For counting milestones
  target_count       Int?          // e.g., 13 books for Q1
  current_count      Int           @default(0)

  // XP
  xp_reward          Int           @default(0)
  bonus_xp           Int           @default(0)  // Stage completion bonus

  // Narrative
  mentor_message     String?       // Encouragement at this stage
  completion_message String?       // Story beat when completed

  created_at         DateTime      @default(now()) @db.Timestamptz(6)

  tasks              life_quest_tasks[]

  @@index([quest_id])
  @@index([journey_stage])
}

/// Individual tasks within a quest
model life_quest_tasks {
  id                String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id          String                 @db.Uuid
  quest             life_quests            @relation(fields: [quest_id], references: [id], onDelete: Cascade)
  milestone_id      String?                @db.Uuid
  milestone         life_quest_milestones? @relation(fields: [milestone_id], references: [id], onDelete: SetNull)

  title             String
  description       String?

  // Task properties
  difficulty        task_difficulty        @default(MEDIUM)
  estimated_minutes Int                    @default(30)

  // Scheduling
  due_date          DateTime?              @db.Timestamptz(6)
  recurrence_rule   Json?                  // { frequency: 'weekly', daysOfWeek: [1,3,5] }
  is_recurring      Boolean                @default(false)

  // Progress
  is_completed      Boolean                @default(false)
  completed_at      DateTime?              @db.Timestamptz(6)

  // For counting tasks
  target_count      Int?                   // e.g., 1 book
  current_count     Int                    @default(0)

  // XP
  xp_value          Int                    @default(10)
  xp_earned         Int                    @default(0)  // Actual XP with multipliers

  // Variable rewards (stickiness)
  critical_hit      Boolean                @default(false)  // 2x XP (10% chance)

  sort_order        Int                    @default(0)
  created_at        DateTime               @default(now()) @db.Timestamptz(6)
  updated_at        DateTime               @default(now()) @db.Timestamptz(6)

  @@index([quest_id])
  @@index([milestone_id])
  @@index([due_date])
  @@index([is_completed])
}

/// Progress logs for tracking over time (especially counting quests)
model life_quest_logs {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quest_id    String      @db.Uuid
  quest       life_quests @relation(fields: [quest_id], references: [id], onDelete: Cascade)

  log_date    DateTime    @db.Date
  count_added Int         @default(1)   // How many items completed
  notes       String?                   // "Finished 'Project Hail Mary'"
  xp_earned   Int         @default(0)

  created_at  DateTime    @default(now()) @db.Timestamptz(6)

  @@index([quest_id])
  @@index([log_date])
}

/// Pre-built quest templates
model life_quest_templates {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  name              String
  description       String?
  quest_type        life_quest_type
  category          String          // 'reading', 'fitness', 'learning', 'career', 'health'
  icon              String?         // Emoji

  // Template structure (JSON)
  structure         Json            // { milestones: [...], defaultTarget: 52, unit: 'books' }

  // Popularity
  times_used        Int             @default(0)
  avg_completion    Float?          // Average completion rate

  // Metadata
  is_featured       Boolean         @default(false)
  is_system         Boolean         @default(true)  // System vs user-created

  created_at        DateTime        @default(now()) @db.Timestamptz(6)

  quests            life_quests[]

  @@index([category])
  @@index([quest_type])
  @@index([is_featured])
}

/// Track AI quest generation usage for tier limits
model ai_quest_usage {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String   @db.Uuid
  month           DateTime @db.Date  // First of month for grouping
  generation_count Int     @default(0)
  last_used       DateTime @default(now()) @db.Timestamptz(6)

  @@unique([user_id, month])
  @@index([user_id])
}

// ============================================
// WEEKLY LEAGUES SYSTEM
// ============================================

enum league_tier {
  BRONZE      // Tier 1 - Starting tier
  SILVER      // Tier 2
  GOLD        // Tier 3
  PLATINUM    // Tier 4
  DIAMOND     // Tier 5
  OBSIDIAN    // Tier 6
  LEGENDARY   // Tier 7 - Top tier
}

/// Weekly league instances (30 users per league)
model leagues {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tier        league_tier @default(BRONZE)
  week_start  DateTime    @db.Date  // Start of the week
  week_end    DateTime    @db.Date  // End of the week (Sunday 11:59pm)
  created_at  DateTime    @default(now()) @db.Timestamptz(6)

  members     league_members[]

  @@index([tier])
  @@index([week_start])
  @@index([week_end])
}

/// User membership in a weekly league
model league_members {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  league_id   String    @db.Uuid
  league      leagues   @relation(fields: [league_id], references: [id], onDelete: Cascade)
  user_id     String    @db.Uuid
  weekly_xp   Int       @default(0)  // XP earned this week
  rank        Int?                   // Current position in league
  promoted    Boolean?               // True if promoted after week ends
  demoted     Boolean?               // True if demoted after week ends
  joined_at   DateTime  @default(now()) @db.Timestamptz(6)

  @@unique([league_id, user_id])
  @@unique([user_id, league_id]) // For finding user's league
  @@index([league_id])
  @@index([user_id])
  @@index([weekly_xp])
}

/// Historical league performance
model league_history {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String      @db.Uuid
  week_start      DateTime    @db.Date
  week_end        DateTime    @db.Date
  tier            league_tier
  final_rank      Int
  weekly_xp       Int
  promoted        Boolean     @default(false)
  demoted         Boolean     @default(false)
  badge_earned    String?     // 'top_3', 'top_10', 'promoted', etc.
  created_at      DateTime    @default(now()) @db.Timestamptz(6)

  @@unique([user_id, week_start])
  @@index([user_id])
  @@index([week_start])
}

/// User's overall league stats
model league_stats {
  id                  String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id             String      @unique @db.Uuid
  current_tier        league_tier @default(BRONZE)
  highest_tier        league_tier @default(BRONZE)
  weeks_participated  Int         @default(0)
  total_promotions    Int         @default(0)
  total_demotions     Int         @default(0)
  top_3_finishes      Int         @default(0)
  first_place_wins    Int         @default(0)
  updated_at          DateTime    @default(now()) @db.Timestamptz(6)

  @@index([user_id])
  @@index([current_tier])
}

// ============================================
// BATTLE PASS / SEASONS SYSTEM
// ============================================

enum season_status {
  UPCOMING
  ACTIVE
  ENDED
}

/// Season definition (90 days, 50 tiers)
model seasons {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String        // "Summer Grind", "Winter Warrior"
  theme         String?       // Visual theme identifier
  description   String?
  icon          String?       // Emoji or icon code
  starts_at     DateTime      @db.Timestamptz(6)
  ends_at       DateTime      @db.Timestamptz(6)
  tier_count    Int           @default(50)
  xp_per_tier   Int           @default(1000)  // Season XP needed per tier
  status        season_status @default(UPCOMING)
  created_at    DateTime      @default(now()) @db.Timestamptz(6)

  tiers         season_tiers[]
  challenges    season_challenges[]
  user_progress user_season_progress[]

  @@index([status])
  @@index([starts_at])
  @@index([ends_at])
}

/// Rewards for each tier in a season
model season_tiers {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  season_id       String   @db.Uuid
  season          seasons  @relation(fields: [season_id], references: [id], onDelete: Cascade)
  tier_number     Int      // 1-50
  free_reward     Json     // { type: 'xp', amount: 100 } or { type: 'item', code: 'streak_shield' }
  premium_reward  Json?    // { type: 'cosmetic', code: 'frame_gold' }
  is_milestone    Boolean  @default(false)  // Every 5 or 10 tiers

  @@unique([season_id, tier_number])
  @@index([season_id])
}

/// User's progress in a season
model user_season_progress {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String    @db.Uuid
  season_id     String    @db.Uuid
  season        seasons   @relation(fields: [season_id], references: [id], onDelete: Cascade)
  season_xp     Int       @default(0)       // XP earned this season
  current_tier  Int       @default(0)       // Current unlocked tier
  has_premium   Boolean   @default(false)   // Purchased battle pass
  claimed_free  Int[]     @default([])      // Array of claimed free tier numbers
  claimed_premium Int[]   @default([])      // Array of claimed premium tier numbers
  purchased_at  DateTime? @db.Timestamptz(6)  // When premium was purchased
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @default(now()) @db.Timestamptz(6)

  @@unique([user_id, season_id])
  @@index([user_id])
  @@index([season_id])
}

/// Cross-app challenges for bonus season XP
model season_challenges {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  season_id       String   @db.Uuid
  season          seasons  @relation(fields: [season_id], references: [id], onDelete: Cascade)
  title           String   // "Triple Crown"
  description     String   // "Complete a workout, task, and location in same day"
  type            String   // 'daily', 'weekly', 'season'
  requirements    Json     // { apps: ['fitness', 'today', 'travel'], counts: [1, 1, 1] }
  xp_reward       Int      @default(100)  // Season XP reward
  starts_at       DateTime? @db.Timestamptz(6)  // For time-limited challenges
  ends_at         DateTime? @db.Timestamptz(6)
  sort_order      Int      @default(0)
  active          Boolean  @default(true)

  completions     season_challenge_completions[]

  @@index([season_id])
  @@index([type])
  @@index([active])
}

/// Track user completion of season challenges
model season_challenge_completions {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String            @db.Uuid
  challenge_id    String            @db.Uuid
  challenge       season_challenges @relation(fields: [challenge_id], references: [id], onDelete: Cascade)
  progress        Json              @default("{}")  // Track progress toward requirements
  completed       Boolean           @default(false)
  completed_at    DateTime?         @db.Timestamptz(6)
  xp_claimed      Boolean           @default(false)
  created_at      DateTime          @default(now()) @db.Timestamptz(6)

  @@unique([user_id, challenge_id])
  @@index([user_id])
  @@index([challenge_id])
  @@index([completed])
}

// ============================================
// PUSH NOTIFICATIONS SYSTEM
// ============================================

/// Web push subscriptions
model push_subscriptions {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String   @db.Uuid
  endpoint      String   @unique  // Push service endpoint
  p256dh        String   // Public key
  auth          String   // Auth secret
  user_agent    String?  // Browser/device info
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  last_used     DateTime @default(now()) @db.Timestamptz(6)

  @@index([user_id])
}

/// User notification preferences
model notification_preferences {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String   @unique @db.Uuid

  // Push notification toggles
  push_enabled          Boolean  @default(true)
  streak_reminder_6pm   Boolean  @default(true)   // "Don't forget to stay active!"
  streak_danger_9pm     Boolean  @default(true)   // "Streak at risk!"
  achievement_unlock    Boolean  @default(true)   // New achievement earned
  league_updates        Boolean  @default(true)   // Promotion/demotion, rank changes
  daily_summary         Boolean  @default(false)  // Optional daily digest
  friend_activity       Boolean  @default(true)   // Friend requests, kudos

  // Email notification toggles
  email_enabled         Boolean  @default(true)
  email_weekly_digest   Boolean  @default(true)
  email_streak_danger   Boolean  @default(true)   // Email if push not opened
  email_promotions      Boolean  @default(false)  // Marketing emails

  // Quiet hours
  quiet_start           String?  // "22:00"
  quiet_end             String?  // "08:00"
  timezone              String   @default("America/Los_Angeles")

  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @default(now()) @db.Timestamptz(6)

  @@index([user_id])
}

/// Notification history (for analytics and retry logic)
model notification_log {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String   @db.Uuid
  type            String   // 'streak_reminder', 'achievement', 'league', etc.
  channel         String   // 'push', 'email'
  title           String
  body            String?
  data            Json?    // Additional payload
  sent_at         DateTime @default(now()) @db.Timestamptz(6)
  delivered       Boolean? // Push delivery confirmed
  opened          Boolean  @default(false)
  opened_at       DateTime? @db.Timestamptz(6)
  error           String?  // If failed

  @@index([user_id])
  @@index([type])
  @@index([sent_at])
}
